#include "params.h"
#include "reduce.h"
#include "ntt.h"

int16_t zetas[383] = {2424, 2192, 708, 460, 1265, 722, 723, 1, 2590, 257, 1124, 1590, 1262, 3235, 1611, 3201, 1484, 3100, 395, 2111, 2293, 1936, 1741, 1577, 95, 699, 2916, 39, 44, 2216, 550, 3002, 639, 2955, 2802, 603, 1744, 2352, 1058, 3336, 2700, 216, 2637, 2564, 3070, 937, 348, 1507, 1257, 3281, 156, 2627, 3407, 3453, 2832, 565, 992, 1877, 2029, 3077, 2851, 2164, 2796, 2008, 2620, 901, 1637, 1617, 2888, 1199, 1530, 1267, 1784, 281, 1558, 1993, 2869, 2442, 3021, 2496, 2816, 87, 630, 371, 64, 2909, 800, 1351, 1081, 1331, 1413, 3252, 3403, 2623, 2782, 2245, 760, 2135, 2586, 601, 3160, 2327, 1473, 2683, 1786, 696, 1583, 2968, 512, 2530, 2943, 3222, 444, 2248, 2093, 2116, 2210, 2251, 3426, 312, 352, 443, 943, 2207, 8, 1660, 100, 2319, 223, 3060, 1059, 3274, 1655, 2898, 1674, 437, 1734, 277, 933, 1817, 3025, 242, 1514, 2349, 3182, 3435, 1748, 2489, 858, 1728, 354, 2236, 218, 294, 2725, 2565, 2362, 2678, 1869, 1063, 1022, 1188, 2404, 417, 2066, 27, 1626, 251, 2056, 1409, 1501, 3227, 361, 582, 2784, 1367, 124, 1531, 1550, 1681, 2517, 1999, 2078, 274, 3057, 3425, 1914, 2049, 1248, 3142, 1772, 664, 40, 1386, 500, 2215, 1258, 1760, 1897, 869, 94, 2220, 1175, 884, 3302, 679, 3248, 2432, 3187, 2744, 82, 3198, 151, 1948, 159, 184, 1094, 2300, 3304, 947, 182, 3195, 2275, 83, 5, 2766, 1791, 709, 2750, 220, 3262, 1405, 876, 2006, 579, 1839, 1277, 517, 406, 304, 2559, 343, 2603, 1264, 451, 1972, 452, 23, 1001, 2016, 413, 2279, 887, 2560, 2445, 2171, 1297, 1210, 656, 1385, 1208, 1756, 1272, 1472, 1838, 1115, 2233, 662, 1456, 1361, 915, 38, 752, 475, 2486, 158, 2217, 1975, 1785, 435, 3150, 252, 1348, 717, 543, 320, 1602, 977, 3141, 113, 2964, 1515, 2507, 3381, 1953, 1086, 2023, 3204, 2817, 2696, 2953, 2587, 614, 2912, 2133, 1830, 735, 1009, 1227, 513, 3238, 1312, 1037, 2572, 863, 2544, 3402, 687, 1041, 3147, 1689, 3039, 2099, 2350, 2474, 1719, 3269, 1000, 685, 2129, 3377, 337, 3394, 2484, 941, 364, 1563, 1093, 524, 3151, 2314, 3089, 1269, 164, 1426, 2050, 540, 318, 3018, 518, 3155, 2554, 3236, 812, 2423, 1158, 2902, 647, 1705, 125, 1382, 3291, 3447, 3067, 3017, 2039, 1414, 1774, 2356, 1433, 1794, 826, 2882, 3411, 1455, 1749, 2771, 2849, 1796, 904, 2970, 929, 2555};

int16_t zetas_inv[383] = {902, 2528, 487, 2553, 1661, 608, 686, 1708, 2002, 46, 575, 2631, 1663, 2024, 1101, 1683, 2043, 1418, 440, 390, 10, 166, 2075, 3332, 1752, 2810, 555, 2299, 1034, 2645, 221, 903, 302, 2939, 439, 3139, 2917, 1407, 2031, 3293, 2188, 368, 1143, 306, 2933, 2364, 1894, 3093, 2516, 973, 63, 3120, 80, 1328, 2772, 2457, 188, 1738, 983, 1107, 1358, 418, 1768, 310, 2416, 2770, 55, 913, 2594, 885, 2420, 2145, 219, 2944, 2230, 2448, 2722, 1627, 1324, 545, 2843, 870, 504, 761, 640, 253, 1434, 2371, 1504, 76, 950, 1942, 493, 3344, 316, 2480, 1855, 3137, 2914, 2740, 2109, 3205, 307, 3022, 1672, 1482, 1240, 3299, 971, 2982, 2705, 3419, 2542, 2096, 2001, 2795, 1224, 2342, 1619, 1985, 2185, 1701, 2249, 2072, 2801, 2247, 2160, 1286, 1012, 897, 2570, 1178, 3044, 1441, 2456, 3434, 3005, 1485, 3006, 2193, 854, 3114, 898, 3153, 3051, 2940, 2180, 1618, 2878, 1451, 2581, 2052, 195, 3237, 707, 2748, 1666, 691, 3452, 3374, 1182, 262, 3275, 2510, 153, 1157, 2363, 3273, 3298, 1509, 3306, 259, 3375, 713, 270, 1025, 209, 2778, 155, 2573, 2282, 1237, 3363, 2588, 1560, 1697, 2199, 1242, 2957, 2071, 3417, 2793, 1685, 315, 2209, 1408, 1543, 32, 400, 3183, 1379, 1458, 940, 1776, 1907, 1926, 3333, 2090, 673, 2875, 3096, 230, 1956, 2048, 1401, 3206, 1831, 3430, 1391, 3040, 1053, 2269, 2435, 2394, 1588, 779, 1095, 892, 732, 3163, 3239, 1221, 3103, 1729, 2599, 968, 1709, 22, 275, 1108, 1943, 3215, 432, 1640, 2524, 3180, 1723, 3020, 1783, 559, 1802, 183, 2398, 397, 3234, 1138, 3357, 1797, 3449, 1250, 2514, 3014, 3105, 3145, 31, 1206, 1247, 1341, 1364, 1209, 3013, 235, 514, 927, 2945, 489, 1874, 2761, 1671, 774, 1984, 1130, 297, 2856, 871, 1322, 2697, 1212, 675, 834, 54, 205, 2044, 2126, 2376, 2106, 2657, 548, 3393, 3086, 2827, 3370, 641, 961, 436, 1015, 588, 1464, 1899, 3176, 1673, 2190, 1927, 2258, 569, 1840, 1820, 2556, 837, 1449, 661, 1293, 606, 380, 1428, 1580, 2465, 2892, 625, 4, 50, 830, 3301, 176, 2200, 1950, 3109, 2520, 387, 893, 820, 3241, 757, 121, 2399, 1105, 1713, 2854, 655, 502, 2818, 455, 2907, 1241, 3413, 3418, 541, 2758, 3362, 1880, 1716, 1521, 1164, 1346, 3062, 357, 1973, 256, 1846, 222, 2195, 1867, 2333, 3200, 867, 3456, 2734, 2735, 248, 1510, 2775, 3209, 1792};

void ntt(int16_t b[NTRUPLUS_N], const int16_t a[NTRUPLUS_N])
{
	int16_t t1,t2,t3,t4;
	int16_t zeta1, zeta2;
	int k = 0;

	zeta1 = zetas[k++];

	for(int i = 0; i < NTRUPLUS_N/2; i++)
	{
		t1 = fqmul(zeta1, a[i + NTRUPLUS_N/2]);

		b[i + NTRUPLUS_N/2] = (a[i] + a[i + NTRUPLUS_N/2] - t1);
		b[i      ] = (a[i] + t1);
	}

	for(int start = 0; start < NTRUPLUS_N; start += 384)
	{
		zeta1 = zetas[k++];
		zeta2 = zetas[k++];

		for(int i = start; i < start + 128; i++)
		{
			t1 = fqmul(zeta1, b[i + 128]);
			t2 = fqmul(zeta2, b[i + 256]);
			t3 = fqmul(2571, t1);
			t4 = fqmul(1033, t2);

			t1 = t1 + t2;
			t3 = t3 + t4;

			b[i + 256] = fqred16(b[i] - (t1 + t3));
			b[i + 128] = fqred16(b[i] + t3);
			b[i    ] = fqred16(b[i] + t1);
		}
	}

	for(int step = 64; step >= 2; step >>= 1)
	{
		for(int start = 0; start < NTRUPLUS_N; start += (step << 1))
		{
			zeta1 = zetas[k++];

			for(int i = start; i < start + step; i++)
			{
				t1 = fqmul(zeta1, b[i + step]);
				
				b[i + step] = fqred16(b[i] - t1);
				b[i       ] = fqred16(b[i] + t1);
			}
		}
	}
}

void invntt(int16_t r[NTRUPLUS_N], const int16_t a[NTRUPLUS_N])
{
	int16_t t1,t2,t3,t4;
	int16_t zeta1,zeta2;
	int k = 0;

	for(int i = 0; i < NTRUPLUS_N; i++)
	{
		r[i] = a[i];
	}

	for(int step = 2; step <= 64; step <<= 1)
	{
		for(int start = 0; start < NTRUPLUS_N; start += (step << 1))
		{
			zeta1 = zetas_inv[k++];

			for(int i = start; i < start + step; i++)
			{
				t1 = r[i + step];

				r[i + step] = fqred16(fqmul(zeta1, r[i] - t1));
				r[i       ] = fqred16(r[i] + t1);
			}
		}
	}

	for(int start = 0; start < NTRUPLUS_N; start += 384)
	{
		zeta1 = zetas_inv[k++];
		zeta2 = zetas_inv[k++];

		for(int i = start; i < start + 128; i++)
		{
			t1 = fqred16(fqmul(1033, r[i + 128]) + fqmul(2571, r[i + 256]));
			t2 = fqred16(r[i + 128] + r[i + 256]);

			r[i + 256] = fqred16(fqmul(zeta2, r[i] - (t1 + t2)));
			r[i + 128] = fqred16(fqmul(zeta1, r[i] + t1));
			r[i    ] = fqred16(r[i] + t2);
		}
	}

	zeta1 = zetas_inv[k];

	for(int i = 0; i < NTRUPLUS_N/2; i++)
	{
		t1 = fqred16(r[i] + r[i + NTRUPLUS_N/2]);
		t2 = fqmul(zeta1, r[i] - r[i + NTRUPLUS_N/2]);

		r[i      ] = fqred16(fqmul(2568, t1 - t2));
		r[i + 384] = fqred16(fqmul(1679, t2));	
	}
}

void basemul(int16_t c[2], const int16_t a[2], const int16_t b[2], int16_t zeta)
{
	int16_t t1 = fqmul(a[0], b[0]);
	int16_t t2 = fqmul(a[1], b[1]);
	int16_t t3 = fqmul((a[0] + a[1]),(b[0] + b[1]));

	c[1] = t3 - t1 - t2;
	c[0] = fqmul(t2, zeta);
	c[0] += t1;
}

int baseinv(int16_t b[2], const int16_t a[2], int16_t zeta)
{
	int16_t det, t;
	int r;

	det = fqmul(a[0], a[0]);
	t = fqmul(a[1], a[1]);
	t = fqmul(t, zeta);
	det = det - t;

	det   = fqinv(det);
	b[0] = fqmul(a[0], det);
	b[1] = fqmul(NTRUPLUS_Q - a[1], det);

	r = (uint16_t)det;
	r = (uint32_t)(-r) >> 31;
	return r - 1;
}